<!DOCTYPE HTML>
<html>
<head>
<script src="d3.v5.min.js"></script>
<script src="image-util.js"></script>
<script src="stipple.js"></script>
<script src="solver.js"></script>
</head>
<body>
<canvas id="greyscale"></canvas>
<canvas id="stipple"></canvas>
</body>
<script>

async function run() {
  // Init
  const SIZE = 400;
  const canvas = document.getElementById('greyscale');
  const ctx = canvas.getContext('2d');
  canvas.width = SIZE;
  canvas.height = SIZE;

  const stippleCanvas = document.getElementById('stipple');
  stippleCtx = stippleCanvas.getContext('2d');
  stippleCanvas.width = SIZE;
  stippleCanvas.height = SIZE;

  // Load
  const image = await ImageUtil.loadImage('tree.jpeg', { width: SIZE, height: SIZE });

  // Greyscale
  const greyScale = ImageUtil.flatten(image.data, { width: SIZE, height: SIZE });

  // Invert
  const inverted = ImageUtil.invert(greyScale);

  // Blur
  let blur = ImageUtil.convolve(inverted, { width: SIZE, height: SIZE, channels: 1 }, 
    ImageUtil.blur5x5
  );

  const blah = ImageUtil.dodge(blur, greyScale);

  const testImg = blah;
  const realImg = greyScale;

  // Rebuild greyscale
  const imageData = ctx.createImageData(SIZE, SIZE);
  for (let i = 0; i < realImg.length; i ++) {
    const v = realImg[i] * 255;
    imageData.data[4 * i + 0] = v;
    imageData.data[4 * i + 1] = v;
    imageData.data[4 * i + 2] = v;
    imageData.data[4 * i + 3] = 255;
  }
  ctx.putImageData(imageData, 0 , 0);

  // Stippling
  const stippledData = stipple(testImg, SIZE, SIZE, { 
    sampleSize: 2,
    sampleThreshold: 0.94
  });


  const drawPath = nearestNeighbour(stippledData.result);

  for (let i = 0; i < drawPath.length - 1; i ++) {
    const d = Math.sqrt(
      (drawPath[i + 1].x - drawPath[i].x) * (drawPath[i + 1].x - drawPath[i].x) +
      (drawPath[i + 1].y - drawPath[i].y) * (drawPath[i + 1].y - drawPath[i].y));
    if (d > 30) continue;

    stippleCtx.beginPath();
    stippleCtx.moveTo(drawPath[i].x, drawPath[i].y);
    stippleCtx.lineTo(drawPath[i + 1].x, drawPath[i + 1].y);

    stippleCtx.closePath();
    stippleCtx.stroke();
  }
  
}
run();
</script>
</html>
