<!DOCTYPE HTML>
<html>
<head>
<script src="d3.v5.min.js"></script>
<script src="image-util.js"></script>
<script src="stipple.js"></script>
<script src="solver.js"></script>
</head>
<body>
<canvas id="stage1"></canvas>
<canvas id="stage2"></canvas>
<canvas id="stage3"></canvas>
</body>
<script>

const SIZE = 300;

const canvasCtx = (id) => {
  const canvas = document.getElementById(id);
  canvas.width = SIZE;
  canvas.height = SIZE;
  return canvas.getContext('2d');
}

const drawSingleChannel = (ctx, data) => {
  const imageData = ctx.createImageData(SIZE, SIZE);
  for (let i = 0; i < data.length; i ++) {
    const v = data[i] * 255;
    imageData.data[4 * i + 0] = v;
    imageData.data[4 * i + 1] = v;
    imageData.data[4 * i + 2] = v;
    imageData.data[4 * i + 3] = 255;
  }
  ctx.putImageData(imageData, 0 , 0);
}


async function run() {
  // Init
  const stage1Ctx = canvasCtx('stage1');
  const stage2Ctx = canvasCtx('stage2');
  const stage3Ctx = canvasCtx('stage3');

  // Load
  const image = await ImageUtil.loadImage('tree.jpeg', { width: SIZE, height: SIZE });

  // Greyscale
  const greyScale = ImageUtil.flatten(image.data, { width: SIZE, height: SIZE });

  // Invert
  const inverted = ImageUtil.invert(greyScale);

  // Blur
  const blur = ImageUtil.convolve(inverted, { width: SIZE, height: SIZE, channels: 1 }, 
    ImageUtil.blur5x5
  );

  // Dodge
  const dodge = ImageUtil.dodge(blur, greyScale);

  // Stippling
  const stippledData = stipple(dodge, SIZE, SIZE, { 
    sampleSize: 1,
    sampleThreshold: 0.85
  });

  // Stage-1
  drawSingleChannel(stage1Ctx, greyScale);

  // Stage-2
  drawSingleChannel(stage2Ctx, dodge);


  const drawPath = nearestNeighbour(stippledData.result);
  for (let i = 0; i < drawPath.length - 1; i ++) {
    const d = Math.sqrt(
      (drawPath[i + 1].x - drawPath[i].x) * (drawPath[i + 1].x - drawPath[i].x) +
      (drawPath[i + 1].y - drawPath[i].y) * (drawPath[i + 1].y - drawPath[i].y));
    if (d > 50) continue;

    stage3Ctx.beginPath();
    stage3Ctx.moveTo(drawPath[i].x, drawPath[i].y);
    stage3Ctx.lineTo(drawPath[i + 1].x, drawPath[i + 1].y);

    stage3Ctx.closePath();
    stage3Ctx.stroke();
  }
  
}
run();
</script>
</html>
